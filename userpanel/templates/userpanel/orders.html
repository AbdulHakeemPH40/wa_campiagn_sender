{% extends 'userpanel/base.html' %}
{% load static %}

{% block title %}My Orders - WA Campaign Sender{% endblock %}

{% block page_title %}My Orders{% endblock %}

{% block content %}
<div class="mb-4 md:mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4 mb-4 md:mb-6">
        <div class="relative w-full md:w-64">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <i class="ri-search-line text-gray-400"></i>
            </div>
            <input type="text" id="search-orders" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full pl-10 p-2.5" placeholder="Search orders...">
        </div>
                <div class="flex flex-col md:flex-row md:items-center gap-3">
            <div class="relative">
                <select id="status-filter" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 pr-8 appearance-none">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                    <i class="ri-arrow-down-s-line text-gray-400"></i>
                </div>
            </div>
                        <div class="flex items-center flex-wrap gap-2">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="ri-calendar-line text-gray-400"></i>
                    </div>
                    <input type="date" id="date-from" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full pl-10 p-2.5" placeholder="From">
                </div>
                <span class="text-gray-500">to</span>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="ri-calendar-line text-gray-400"></i>
                    </div>
                    <input type="date" id="date-to" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full pl-10 p-2.5" placeholder="To">
                </div>
            </div>
            <button id="clear-filters" class="text-gray-500 hover:text-gray-700 flex items-center !rounded-button whitespace-nowrap">
                <i class="ri-filter-off-line mr-1"></i>
                Clear Filters
            </button>
        </div>
    </div>
</div>
<div class="overflow-x-auto bg-white rounded-lg shadow-sm relative">
    <table class="min-w-full table-auto text-sm md:text-base">
        <thead>
            <tr class="border-b">
                <th scope="col" class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-medium text-gray-600">Order</th>
                <th scope="col" class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-medium text-gray-600 hidden sm:table-cell">Date</th>
                <th scope="col" class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-medium text-gray-600">Status</th>
                <th scope="col" class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-medium text-gray-600">Total</th>
                <th scope="col" class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-medium text-gray-600">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% if orders %}
                {% for order in orders %}
                <tr class="hover:bg-gray-50">
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                        <div class="text-xs md:text-sm text-gray-900">{{ order.order_id }}</div>
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap hidden sm:table-cell">
                        <div class="text-xs md:text-sm text-gray-900">{{ order.created_at|date:"M d, Y" }}</div>
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                        {% if order.status == 'pending' %}
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Pending</span>
                        {% elif order.status == 'processing' %}
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Processing</span>
                        {% elif order.status == 'shipped' %}
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">Shipped</span>
                        {% elif order.status == 'delivered' %}
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Delivered</span>
                        {% elif order.status == 'cancelled' %}
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Cancelled</span>
                        {% else %}
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">{{ order.status|capfirst }}</span>
                        {% endif %}
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                        <div class="text-xs md:text-sm font-medium text-gray-900">${{ order.total }}</div>
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                        <div class="flex space-x-2">
                            <a href="{% url 'userpanel:order_invoice' order.order_id %}" class="px-2 py-1 text-xs md:text-sm rounded-button text-secondary hover:bg-green-50 border border-secondary flex items-center">
                                <i class="ri-eye-line"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" class="text-center py-8">
                        <div class="flex flex-col items-center justify-center space-y-4">
                            <div class="bg-gray-100 p-4 rounded-full">
                                <i class="ri-shopping-bag-line text-4xl text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-800">No Orders Yet</h3>
                            <p class="text-gray-500 max-w-sm mt-2">You haven't made any purchases yet. Your order history will appear here when you complete a purchase.</p>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                $0.00
                            </td>
                        </div>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Invoice Modal -->
<div id="invoice-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">Invoice  #<span id="invoice-number"></span></h2>
            <button id="close-invoice" class="text-gray-600 hover:text-gray-900">
                <i class="ri-close-line text-2xl"></i>
            </button>
        </div>
        <div id="invoice-loading" class="p-12 flex justify-center items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
        </div>
        <div id="invoice-content" class="p-6 hidden">
            <!-- Invoice Header -->
            <div class="flex flex-col md:flex-row justify-between mb-8">
                <div>
                    <div class="flex items-center mb-4">
                        <img src="{% static 'image/logo.png' %}" alt="WA Campaign Sender Logo" class="h-8 mr-2">
                        <h3 class="text-lg font-semibold">WA Campaign Sender</h3>
                    </div>
                    <p class="text-gray-600" id="company-address-line1">123 Commerce Street</p>
                    <p class="text-gray-600" id="company-address-line2">Tech City, TC 10001</p>
                    <p class="text-gray-600" id="company-email">contact@wacampaignsender.com</p>
                </div>
                <div class="mt-6 md:mt-0 text-right">
                    <div class="text-gray-600">Invoice Date</div>
                    <div class="font-semibold" id="invoice-date"></div>
                    <div class="mt-2 text-gray-600">Order Number</div>
                    <div class="font-semibold" id="order-number"></div>
                </div>
            </div>
            
            <!-- Customer Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">Bill To</h4>
                    <p class="text-gray-600" id="customer-name"></p>
                    <p class="text-gray-600" id="customer-email">{{ request.user.email }}</p>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2">Ship To</h4>
                    <p class="text-gray-600" id="shipping-name"></p>
                    <p class="text-gray-600" id="shipping-address"></p>
                    <p class="text-gray-600"><span id="shipping-city"></span><span id="shipping-state-comma">, </span><span id="shipping-state"></span> <span id="shipping-postal-code"></span></p>
                    <p class="text-gray-600" id="shipping-country"></p>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="mb-8">
                <h4 class="font-semibold text-gray-800 mb-2">Payment Method</h4>
                <div class="flex items-center">
                    <i id="payment-icon" class="ri-bank-card-line text-xl mr-2 text-gray-700"></i>
                    <span id="payment-method"></span>
                </div>
            </div>
            
            <!-- Invoice Items -->
            <div class="overflow-x-auto mb-8">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700">Item</th>
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-700">Description</th>
                            <th class="py-2 px-4 text-center text-sm font-semibold text-gray-700">Quantity</th>
                            <th class="py-2 px-4 text-right text-sm font-semibold text-gray-700">Price</th>
                            <th class="py-2 px-4 text-right text-sm font-semibold text-gray-700">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items">
                        <!-- Items will be inserted here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <!-- Invoice Totals -->
            <div class="flex justify-end">
                <div class="w-full md:w-1/2 lg:w-1/3">
                    <div class="flex justify-between py-2">
                        <span class="text-gray-600">Subtotal</span>
                        <span id="invoice-subtotal"></span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span class="text-gray-600">Discount</span>
                        <span id="invoice-discount"></span>
                    </div>
                    <div class="flex justify-between py-2 font-semibold">
                        <span>Total</span>
                        <span id="invoice-total"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Invoice Error -->
        <div id="invoice-error" class="p-6 hidden">
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" id="error-message">An error occurred while loading the invoice.</span>
            </div>
        </div>
        
        <!-- Invoice Footer -->
        <div class="p-6 bg-gray-50 flex flex-col md:flex-row gap-4 justify-between items-center">
            <div class="text-gray-500 text-sm">
                <p>Thank you for your business!</p>
            </div>
            <div class="flex gap-3">
                <button id="print-invoice" class="px-4 py-2 bg-white text-primary border border-primary rounded-md hover:bg-gray-50 flex items-center">
                    <i class="ri-printer-line mr-1"></i> Print
                </button>
                <button id="download-invoice" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark flex items-center">
                    <i class="ri-download-line mr-1"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Invoice Modal Elements ---
    const modal = document.getElementById('invoice-modal');
    const closeModalBtn = document.getElementById('close-invoice');
    const invoiceBtns = document.querySelectorAll('.view-invoice-btn');  // This matches the class in the HTML
    const invoiceLoading = document.getElementById('invoice-loading');
    const invoiceContent = document.getElementById('invoice-content');
    const invoiceError = document.getElementById('invoice-error');
    const printInvoiceBtn = document.getElementById('print-invoice');
    const downloadInvoiceBtn = document.getElementById('download-invoice');
    
    // Set up event listeners for invoice buttons
    if (invoiceBtns && invoiceBtns.length > 0) {
        invoiceBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const orderId = this.getAttribute('data-order-id');
                openModal();
                loadInvoice(orderId);
            });
        });
    }
    
    // Close modal when close button is clicked
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }
    
    // Close modal when clicking outside the modal content
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
    }

    // --- Filter Elements ---
    const searchInput = document.getElementById('search-orders');
    const statusFilter = document.getElementById('status-filter');
    const dateFromInput = document.getElementById('date-from');
    const dateToInput = document.getElementById('date-to');
    const clearFiltersBtn = document.getElementById('clear-filters');

    // --- Helper Functions ---
    function formatCurrency(amount) {
        return '₹' + parseFloat(amount).toLocaleString('en-IN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- Invoice Modal Logic ---
    function resetInvoiceModal() {
        if (invoiceLoading && invoiceContent && invoiceError) {
            invoiceLoading.classList.remove('hidden');
            invoiceContent.classList.add('hidden');
            invoiceError.classList.add('hidden');
        }
    }

    function openModal() {
        if (modal) {
            modal.classList.remove('hidden');
        }
    }

    function closeModal() {
        if (modal) {
            modal.classList.add('hidden');
            resetInvoiceModal();
        }
    }
    
    function loadInvoice(orderId) {
        resetInvoiceModal();
        
        // Fetch invoice data with proper error handling
        fetch(`/userpanel/orders/${orderId}/invoice/?is_ajax=1`)
            .then(response => {
                // First check if the response is valid
                return response.text().then(text => {
                    // Try to parse the response as JSON
                    try {
                        const data = JSON.parse(text);
                        
                        // If we get a JSON response with an error field, throw it as an error
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // If the response was not OK (e.g. 404, 500)
                        // but somehow had valid JSON without an error field
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                        
                        return data;
                    } catch (e) {
                        // If we can't parse the response as JSON
                        console.error('Error parsing JSON:', e);
                        if (text.includes('<!DOCTYPE html>')) {
                            console.error('Received HTML instead of JSON');
                            throw new Error('Server returned HTML instead of JSON. Please try again later.');
                        } else {
                            console.error('Response text:', text);
                            throw new Error('Invalid response from server');
                        }
                    }
                });
            })
            .then(data => {
                // Hide loading spinner and show content
                if (invoiceLoading) invoiceLoading.classList.add('hidden');
                if (invoiceContent) invoiceContent.classList.remove('hidden');
                
                // Set basic invoice details
                document.getElementById('invoice-number').textContent = orderId;
                document.getElementById('order-number').textContent = orderId;
                
                // Format date
                if (data.date) {
                    const orderDate = new Date(data.date);
                    document.getElementById('invoice-date').textContent = orderDate.toLocaleDateString('en-US', {
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'
                    });
                }
                
                // Set company information
                if (data.company_info) {
                    document.getElementById('company-address-line1').textContent = data.company_info.address || 'P13 France Cluster, International City, Dubai';
                    document.getElementById('company-address-line2').textContent = '';
                    document.getElementById('company-email').textContent = data.company_info.support_email || 'hi@wacampaignsender.com';
                }
                
                // Set customer information
                if (data.user_address) {
                    document.getElementById('customer-name').textContent = data.user_address.name || 'Customer';
                    document.getElementById('customer-email').textContent = data.user_address.email || '';
                    
                    // Set shipping address
                    document.getElementById('shipping-name').textContent = data.user_address.name || '';
                    document.getElementById('shipping-address').textContent = data.user_address.address_line1 || '';
                    document.getElementById('shipping-city').textContent = data.user_address.city || '';
                    document.getElementById('shipping-state').textContent = data.user_address.state || '';
                    document.getElementById('shipping-postal-code').textContent = data.user_address.postal_code || '';
                    document.getElementById('shipping-country').textContent = data.user_address.country || '';
                    
                    // Show/hide comma between city and state
                    document.getElementById('shipping-state-comma').style.display = 
                        (data.user_address.city && data.user_address.state) ? 'inline' : 'none';
                } else {
                    // Digital product, no shipping required
                    document.getElementById('shipping-address').textContent = 'Digital Product - No Shipping Address Required';
                    document.getElementById('shipping-name').textContent = '';
                    document.getElementById('shipping-city').textContent = '';
                    document.getElementById('shipping-state').textContent = '';
                    document.getElementById('shipping-postal-code').textContent = '';
                    document.getElementById('shipping-country').textContent = '';
                    document.getElementById('shipping-state-comma').style.display = 'none';
                }
                
                // Set payment method
                document.getElementById('payment-icon').className = 'ri-paypal-line text-xl mr-2 text-gray-700';
                document.getElementById('payment-method').textContent = 'PayPal';
                
                // Populate invoice items
                const invoiceItemsContainer = document.getElementById('invoice-items');
                invoiceItemsContainer.innerHTML = '';
                
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="py-3 px-4 border-b">${item.product_name || 'Product'}</td>
                            <td class="py-3 px-4 border-b">${item.product_description || 'WA Campaign Sender subscription service'}</td>
                            <td class="py-3 px-4 border-b text-center">${item.quantity}</td>
                            <td class="py-3 px-4 border-b text-right">$${parseFloat(item.unit_price).toFixed(2)}</td>
                            <td class="py-3 px-4 border-b text-right">$${parseFloat(item.total_price).toFixed(2)}</td>
                        `;
                        invoiceItemsContainer.appendChild(tr);
                    });
                }
                
                // Set totals
                document.getElementById('invoice-subtotal').textContent = data.total || '$0.00';
                document.getElementById('invoice-discount').textContent = '$0.00';
                document.getElementById('invoice-total').textContent = data.total || '$0.00';
            })
            .catch(error => {
                console.error('Error loading invoice:', error);
                if (invoiceLoading) invoiceLoading.classList.add('hidden');
                if (invoiceError) {
                    invoiceError.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'Could not load invoice data. Please try again later.';
                }
            });
    }

    function populateInvoiceData(data, orderId) {
        // Set invoice number
        document.getElementById('invoice-number').textContent = orderId;
        document.getElementById('order-number').textContent = orderId;

        if (data.stripe_invoice) {
            // Handle Stripe invoice data
            const invoice = data.stripe_invoice;
            document.getElementById('invoice-date').textContent = new Date(invoice.created * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('customer-name').textContent = invoice.customer_name || 'Customer';
            
            if (invoice.customer_shipping) {
                const shipping = invoice.customer_shipping;
                document.getElementById('shipping-name').textContent = shipping.name;
                document.getElementById('shipping-address').textContent = shipping.address.line1;
                document.getElementById('shipping-city').textContent = shipping.address.city;
                document.getElementById('shipping-state').textContent = shipping.address.state;
                document.getElementById('shipping-postal-code').textContent = shipping.address.postal_code;
                document.getElementById('shipping-country').textContent = shipping.address.country;
                document.getElementById('shipping-state-comma').style.display = (shipping.address.city && shipping.address.state) ? 'inline' : 'none';
            }

            let paymentMethodText = 'Card';
            let paymentIconClass = 'ri-bank-card-line';
            if (invoice.payment_settings && invoice.payment_settings.payment_method_types) {
                const paymentType = invoice.payment_settings.payment_method_types[0];
                if (paymentType === 'bank_transfer') {
                    paymentIconClass = 'ri-bank-line';
                    paymentMethodText = 'Bank Transfer';
                }
            }
            document.getElementById('payment-icon').className = paymentIconClass + ' text-xl mr-2';
            document.getElementById('payment-method').textContent = paymentMethodText;

            const invoiceItemsContainer = document.getElementById('invoice-items');
            invoiceItemsContainer.innerHTML = '';
            invoice.lines.data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3 px-4 border-b">${item.description}</td>
                    <td class="py-3 px-4 border-b">${item.description}</td>
                    <td class="py-3 px-4 border-b text-center">${item.quantity || 1}</td>
                    <td class="py-3 px-4 border-b text-right">${formatCurrency(item.unit_amount / 100)}</td>
                    <td class="py-3 px-4 border-b text-right">${formatCurrency(item.amount / 100)}</td>
                `;
                invoiceItemsContainer.appendChild(tr);
            });

            document.getElementById('invoice-subtotal').textContent = formatCurrency(invoice.subtotal / 100);
            document.getElementById('invoice-discount').textContent = '-' + formatCurrency((invoice.discount ? invoice.discount.coupon.amount_off / 100 : 0) || 0);
            document.getElementById('invoice-total').textContent = formatCurrency(invoice.total / 100);

        } else if (data.order) {
            // Handle local order data
            const order = data.order;
            const items = data.items;
            
            document.getElementById('invoice-date').textContent = new Date(order.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('customer-name').textContent = order.shipping_name || 'Customer';

            if (order.shipping_name) {
                document.getElementById('shipping-name').textContent = order.shipping_name;
                document.getElementById('shipping-address').textContent = order.shipping_address || '';
                document.getElementById('shipping-city').textContent = order.shipping_city || '';
                document.getElementById('shipping-state').textContent = order.shipping_state || '';
                document.getElementById('shipping-postal-code').textContent = order.shipping_postal_code || '';
                document.getElementById('shipping-country').textContent = order.shipping_country || '';
                document.getElementById('shipping-state-comma').style.display = (order.shipping_city && order.shipping_state) ? 'inline' : 'none';
            }

            let paymentMethodText = order.payment_method || 'Card';
            let paymentIconClass = 'ri-bank-card-line';
            if (order.payment_method) {
                if (order.payment_method.toLowerCase().includes('visa')) {
                    paymentIconClass = 'ri-visa-line';
                } else if (order.payment_method.toLowerCase().includes('mastercard')) {
                    paymentIconClass = 'ri-mastercard-line';
                }
            }
            document.getElementById('payment-icon').className = paymentIconClass + ' text-xl mr-2';
            document.getElementById('payment-method').textContent = paymentMethodText;
             if (order.card_last4) {
                document.getElementById('payment-method').textContent += ` ending in ${order.card_last4}`;
            }

            const invoiceItemsContainer = document.getElementById('invoice-items');
            invoiceItemsContainer.innerHTML = '';
            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-3 px-4 border-b">${item.product_name}</td>
                    <td class="py-3 px-4 border-b">${item.product_description || ''}</td>
                    <td class="py-3 px-4 border-b text-center">${item.quantity}</td>
                    <td class="py-3 px-4 border-b text-right">${formatCurrency(item.unit_price)}</td>
                    <td class="py-3 px-4 border-b text-right">${formatCurrency(item.total_price)}</td>
                `;
                invoiceItemsContainer.appendChild(tr);
            });

            document.getElementById('invoice-subtotal').textContent = formatCurrency(order.subtotal);
            document.getElementById('invoice-discount').textContent = '-' + formatCurrency(order.discount);
            document.getElementById('invoice-total').textContent = formatCurrency(order.total);
        }
    }

    async function showInvoice(orderId) {
        openModal();
        resetInvoiceModal();
        try {
            const encodedOrderId = encodeURIComponent(orderId);
            const response = await fetch(`/userpanel/orders/${encodedOrderId}/invoice/?is_ajax=1`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.success) {
                populateInvoiceData(data, orderId);
                invoiceLoading.classList.add('hidden');
                invoiceContent.classList.remove('hidden');
            } else {
                throw new Error(data.error || 'Failed to load invoice');
            }
        } catch (error) {
            console.error('Error loading invoice:', error);
            document.getElementById('error-message').textContent = error.message;
            invoiceLoading.classList.add('hidden');
            invoiceError.classList.remove('hidden');
        }
    }

    // --- Event Listeners ---
    if (invoiceBtns) {
        invoiceBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                showInvoice(orderId);
            });
        });
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }

    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
    }

    // Print invoice functionality with improved styling and error handling
    if (printInvoiceBtn) {
        printInvoiceBtn.addEventListener('click', function() {
            try {
                const invoiceContainer = document.getElementById('invoice-content');
                if (!invoiceContainer || invoiceContainer.classList.contains('hidden')) {
                    throw new Error('Invoice content not available for printing');
                }
                
                const invoiceToPrint = invoiceContainer.innerHTML;
                const printWindow = window.open('', '', 'height=800,width=1000');
                if (!printWindow) {
                    alert('Your browser blocked the print window. Please allow popups for this site.');
                    return;
                }
                
                // Add proper styling for print with inline CSS instead of Tailwind CDN
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>WA Campaign Sender - Invoice</title>
                        <style>
                            /* Base styles */
                            body {
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                color: #333;
                                padding: 1.5rem;
                                background-color: #f9fafb;
                                margin: 0;
                                -webkit-print-color-adjust: exact !important;
                                color-adjust: exact !important;
                                print-color-adjust: exact;
                            }
                            
                            /* Typography */
                            h1, h2, h3, h4, h5, h6 { margin-top: 0; }
                            .text-sm { font-size: 0.875rem; }
                            .text-lg { font-size: 1.125rem; }
                            .text-xl { font-size: 1.25rem; }
                            .font-medium { font-weight: 500; }
                            .font-semibold { font-weight: 600; }
                            .font-bold { font-weight: 700; }
                            .text-gray-500 { color: #6b7280; }
                            .text-gray-600 { color: #4b5563; }
                            .text-gray-700 { color: #374151; }
                            .text-gray-800 { color: #1f2937; }
                            .text-gray-900 { color: #111827; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            
                            /* Spacing */
                            .p-2 { padding: 0.5rem; }
                            .p-4 { padding: 1rem; }
                            .p-6 { padding: 1.5rem; }
                            .px-4 { padding-left: 1rem; padding-right: 1rem; }
                            .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
                            .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
                            .pt-2 { padding-top: 0.5rem; }
                            .mb-2 { margin-bottom: 0.5rem; }
                            .mb-4 { margin-bottom: 1rem; }
                            .mb-6 { margin-bottom: 1.5rem; }
                            .mb-8 { margin-bottom: 2rem; }
                            .mt-8 { margin-top: 2rem; }
                            .mr-2 { margin-right: 0.5rem; }
                            .ml-3 { margin-left: 0.75rem; }
                            
                            /* Layout */
                            .flex { display: flex; }
                            .grid { display: grid; }
                            .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
                            .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
                            .gap-4 { gap: 1rem; }
                            .gap-6 { gap: 1.5rem; }
                            .items-center { align-items: center; }
                            .justify-between { justify-content: space-between; }
                            
                            /* Components */
                            .border-b { border-bottom: 1px solid #e5e7eb; }
                            .rounded-lg { border-radius: 0.5rem; }
                            .bg-white { background-color: white; }
                            .bg-gray-50 { background-color: #f9fafb; }
                            .bg-gray-100 { background-color: #f3f4f6; }
                            .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
                            
                            /* Table styles */
                            table { width: 100%; border-collapse: collapse; }
                            th { text-align: left; }
                            th, td { padding: 0.75rem 1rem; }
                            thead tr { background-color: #f3f4f6; }
                            tbody tr:hover { background-color: #f9fafb; }
                            
                            /* Print specific */
                            @media print {
                                .no-print { display: none !important; }
                                body { background-color: white !important; padding: 0; }
                                .shadow-sm, .shadow { box-shadow: none !important; }
                                .border { border-color: #e5e7eb !important; }
                                .rounded-lg { border-radius: 0 !important; }
                                @page { margin: 0.5cm; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            ${invoiceToPrint}
                            <div class="mt-8 text-center text-sm text-gray-500">
                                <p>Thank you for your business with WA Campaign Sender!</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    }, 300); // Small delay to ensure styles are loaded
                };
            } catch (error) {
                console.error('Error printing invoice:', error);
                alert('Could not print invoice. Please try again.');
            }
        });
    }

    // Download invoice as PDF functionality with error handling
    if (downloadInvoiceBtn) {
        downloadInvoiceBtn.addEventListener('click', function() {
            try {
                const orderId = document.getElementById('invoice-number')?.textContent;
                if (!orderId) {
                    throw new Error('Could not determine Order ID for download');
                }
                
                const encodedOrderId = encodeURIComponent(orderId);
                const downloadUrl = `/userpanel/orders/${encodedOrderId}/invoice/?format=pdf`;
                
                // Create a temporary link element to download the file
                const downloadLink = document.createElement('a');
                downloadLink.href = downloadUrl;
                downloadLink.target = '_blank'; // Open in new tab as fallback
                downloadLink.setAttribute('download', `invoice-${orderId}.pdf`);
                
                // Append to body, click and remove
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            } catch (error) {
                console.error('Error downloading invoice:', error);
                alert('Could not download invoice. Please try again.');
            }
        });
    }

    // --- Filtering Logic ---
    function applyFilters() {
        const searchTerm = (searchInput ? searchInput.value.toLowerCase() : '');
        const statusValue = (statusFilter ? statusFilter.value : '');
        const dateFromValue = dateFromInput ? dateFromInput.value : '';
        const dateToValue = dateToInput ? dateToInput.value : '';

        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            // Handle the "No Orders Yet" row
            if (row.querySelector('td[colspan="5"]')) {
                return;
            }

            const orderId = row.cells[0].textContent.toLowerCase();
            const date = row.cells[1].textContent;
            const status = row.cells[2].textContent.trim();

            const matchesSearch = orderId.includes(searchTerm);
            const matchesStatus = statusValue === '' || status.toLowerCase().includes(statusValue.toLowerCase());
            
            let matchesDate = true;
            if (dateFromValue || dateToValue) {
                const orderDate = new Date(date);
                const fromDate = dateFromValue ? new Date(dateFromValue) : null;
                const toDate = dateToValue ? new Date(dateToValue) : null;

                if (fromDate && orderDate < fromDate) {
                    matchesDate = false;
                }
                if (toDate && orderDate > toDate) {
                    matchesDate = false;
                }
            }

            if (matchesSearch && matchesStatus && matchesDate) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (statusFilter) statusFilter.addEventListener('change', applyFilters);
    if (dateFromInput) dateFromInput.addEventListener('change', applyFilters);
    if (dateToInput) dateToInput.addEventListener('change', applyFilters);

    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (dateFromInput) dateFromInput.value = '';
            if (dateToInput) dateToInput.value = '';
            applyFilters();
        });
    }
});
</script>
{% endblock %}
