{% extends 'whatsappapi/base.html' %}
{% load static %}

{% block title %}Campaign Detail{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
<div class="max-w-7xl mx-auto">
<div class="space-y-5">
    <!-- Back Button -->
    <div>
        <a href="{% url 'whatsappapi:campaigns' %}" class="text-sm text-neutral-600 hover:text-neutral-900 inline-flex items-center">
            <i class="ri-arrow-left-line mr-1"></i>
            Back to Campaigns
        </a>
    </div>

    <!-- Campaign Header -->
    <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4">
            <div class="flex-1 min-w-0">
                <h2 class="text-lg sm:text-xl font-bold text-neutral-900 break-words">{{ campaign.name }}</h2>
                <div class="flex flex-wrap items-center gap-2 mt-2 text-xs text-neutral-600">
                    <span><i class="ri-calendar-line mr-1"></i>{{ campaign.created_at|date:"M d, Y H:i" }}</span>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <span class="px-2.5 py-1 rounded-full text-xs font-semibold
                    {% if campaign.status == 'completed' %}bg-green-100 text-green-800
                    {% elif campaign.status == 'running' %}bg-blue-100 text-blue-800
                    {% elif campaign.status == 'failed' %}bg-red-100 text-red-800
                    {% elif campaign.status == 'paused' %}bg-yellow-100 text-yellow-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ campaign.status|title }}
                </span>
                {% if campaign.status == 'running' or campaign.status == 'pending' %}
                <button type="button" onclick="openStopModal({{ campaign.id }})" class="px-3 py-2 bg-red-100 text-red-700 border border-red-200 rounded-lg hover:bg-red-200 transition-colors inline-flex items-center text-xs font-semibold">
                    <i class="ri-stop-circle-line mr-1"></i>Stop
                </button>
                {% endif %}
                <a href="{% url 'whatsappapi:export_campaign_messages_excel' campaign.id %}" 
                   class="px-3 py-2 bg-green-100 text-green-700 border border-green-200 rounded-lg hover:bg-green-200 transition-colors inline-flex items-center text-xs font-semibold">
                    <i class="ri-file-excel-2-line mr-1"></i>Export
                </a>
            </div>
        </div>
    </div>

    <!-- Session/Sent From Banner -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 p-4 sm:p-5">
        <div class="flex items-center gap-3">
            <div class="h-12 w-12 bg-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                <i class="ri-smartphone-line text-white text-2xl"></i>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-xs sm:text-sm font-medium text-neutral-600 mb-1">Sent From WhatsApp Number:</p>
                <div class="flex flex-wrap items-center gap-2">
                    <p class="text-base sm:text-lg font-bold text-blue-700">{{ campaign.session.connected_phone_number|default:campaign.session.phone_number }}</p>
                    {% if campaign.session.status == 'connected' %}
                    <span class="px-2.5 py-1 bg-green-100 text-green-700 border border-green-200 rounded-lg text-xs font-semibold inline-flex items-center">
                        <i class="ri-checkbox-circle-fill mr-1"></i>
                        Active
                    </span>
                    {% elif campaign.session.status == 'disconnected' %}
                    <span class="px-2.5 py-1 bg-red-100 text-red-700 border border-red-200 rounded-lg text-xs font-semibold inline-flex items-center">
                        <i class="ri-close-circle-fill mr-1"></i>
                        Disconnected
                    </span>
                    {% endif %}
                </div>
                <p class="text-xs text-neutral-500 mt-1">{{ campaign.session.session_name }}</p>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">Total</p>
                    <p class="text-2xl font-bold text-neutral-900 mt-1">{{ campaign.total_recipients }}</p>
                </div>
                <div class="h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="ri-group-line text-xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">Sent</p>
                    <p class="text-2xl font-bold text-neutral-900 mt-1">{{ campaign.messages_sent }}</p>
                </div>
                <div class="h-10 w-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="ri-send-plane-2-line text-xl text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">Delivered</p>
                    <p class="text-2xl font-bold text-neutral-900 mt-1">{{ campaign.messages_delivered }}</p>
                </div>
                <div class="h-10 w-10 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="ri-checkbox-circle-line text-xl text-purple-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">Failed</p>
                    <p class="text-2xl font-bold text-neutral-900 mt-1">{{ campaign.messages_failed }}</p>
                </div>
                <div class="h-10 w-10 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="ri-close-circle-line text-xl text-red-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Details -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
        <!-- Message Template -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-5">
                <h3 class="text-lg font-semibold text-neutral-900 mb-3">Message Template</h3>
                <div class="bg-neutral-50 rounded-lg p-3 border border-neutral-200">
                    <pre class="text-sm text-neutral-700 whitespace-pre-wrap font-sans">{{ campaign.message_template }}</pre>
                </div>
            </div>

            <!-- Messages List -->
            {% if campaign_messages %}
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-5 mt-5">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-neutral-900">Messages</h3>
                    <span class="px-2 py-1 bg-neutral-100 text-neutral-700 rounded-full text-xs font-semibold">
                        {{ campaign_messages.paginator.count }}
                    </span>
                </div>
                <div class="space-y-2 max-h-80 overflow-y-auto">
                    {% for message in campaign_messages %}
                    <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg hover:bg-neutral-100 transition-colors">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <div class="h-8 w-8 rounded-full flex items-center justify-center flex-shrink-0
                                {% if message.status == 'sent' or message.status == 'delivered' or message.status == 'read' %}bg-green-100
                                {% elif message.status == 'failed' %}bg-red-100
                                {% else %}bg-yellow-100{% endif %}">
                                <i class="{% if message.status == 'sent' or message.status == 'delivered' or message.status == 'read' %}ri-checkbox-circle-fill text-green-600
                                    {% elif message.status == 'failed' %}ri-close-circle-fill text-red-600
                                    {% else %}ri-time-fill text-yellow-600{% endif %} text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-neutral-900 truncate">{{ message.recipient }}</p>
                                <p class="text-xs text-neutral-600 truncate">{{ message.sent_at|date:"M d, Y H:i:s"|default:"Not sent" }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium
                                {% if message.status == 'sent' %}bg-blue-100 text-blue-800
                                {% elif message.status == 'delivered' %}bg-green-100 text-green-800
                                {% elif message.status == 'read' %}bg-purple-100 text-purple-800
                                {% elif message.status == 'failed' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ message.status|title }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if campaign_messages %}
                <div class="flex items-center justify-between mt-4 pt-4 border-t border-neutral-200">
                    <div class="text-xs text-neutral-600">
                        Showing <span class="font-semibold">{{ campaign_messages.start_index }}</span> to <span class="font-semibold">{{ campaign_messages.end_index }}</span> of <span class="font-semibold">{{ campaign_messages.paginator.count }}</span> messages
                    </div>
                    
                    <div class="flex items-center space-x-1">
                        {% if campaign_messages.has_previous %}
                            <a href="?page=1" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">
                                <i class="ri-arrow-left-double-line"></i>
                            </a>
                            <a href="?page={{ campaign_messages.previous_page_number }}" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">
                                <i class="ri-arrow-left-line"></i>
                            </a>
                        {% endif %}
                        
                        {% for num in campaign_messages.paginator.page_range %}
                            {% if campaign_messages.number == num %}
                                <span class="px-2 py-1 rounded bg-blue-600 text-white font-semibold text-xs">{{ num }}</span>
                            {% elif num > campaign_messages.number|add:'-2' and num < campaign_messages.number|add:'2' %}
                                <a href="?page={{ num }}" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if campaign_messages.has_next %}
                            <a href="?page={{ campaign_messages.next_page_number }}" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">
                                <i class="ri-arrow-right-line"></i>
                            </a>
                            <a href="?page={{ campaign_messages.paginator.num_pages }}" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">
                                <i class="ri-arrow-right-double-line"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar Info -->
        <div class="lg:col-span-1 space-y-5">
            <!-- Campaign Info -->
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-5">
                <h3 class="font-semibold text-neutral-900 mb-3">Campaign Info</h3>
                <div class="space-y-2.5 text-sm">
                    <div>
                        <p class="text-neutral-600 text-xs">Created</p>
                        <p class="font-medium text-neutral-900">{{ campaign.created_at|date:"M d, Y H:i" }}</p>
                    </div>
                    {% if campaign.started_at %}
                    <div>
                        <p class="text-neutral-600 text-xs">Started</p>
                        <p class="font-medium text-neutral-900">{{ campaign.started_at|date:"M d, Y H:i" }}</p>
                    </div>
                    {% endif %}
                    {% if campaign.completed_at %}
                    <div>
                        <p class="text-neutral-600 text-xs">Completed</p>
                        <p class="font-medium text-neutral-900">{{ campaign.completed_at|date:"M d, Y H:i" }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-neutral-600 text-xs">Message Type</p>
                        <p class="font-medium text-neutral-900">{{ campaign.message_type|title }}</p>
                    </div>
                </div>
            </div>

            <!-- Success Rate -->
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-5">
                <h3 class="font-semibold text-neutral-900 mb-3">Success Rate</h3>
                {% if campaign.total_recipients > 0 %}
                    {% widthratio campaign.messages_sent campaign.total_recipients 100 as success_rate %}
                    <div class="relative pt-1">
                        <div class="flex mb-1.5 items-center justify-between">
                            <div>
                                <span class="text-xs font-semibold inline-block py-0.5 px-1.5 uppercase rounded-full text-green-600 bg-green-200">
                                    Sent
                                </span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-semibold inline-block text-green-600">
                                    {{ success_rate|default:0 }}%
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-1.5 mb-3 text-xs flex rounded bg-green-200">
                            <div style="width: {{ success_rate|default:0|floatformat:0 }}%;" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500"></div>
                        </div>
                    </div>

                    {% if campaign.messages_delivered > 0 %}
                        {% widthratio campaign.messages_delivered campaign.total_recipients 100 as delivery_rate %}
                        <div class="relative pt-1 mt-3">
                            <div class="flex mb-1.5 items-center justify-between">
                                <div>
                                    <span class="text-xs font-semibold inline-block py-0.5 px-1.5 uppercase rounded-full text-blue-600 bg-blue-200">
                                        Delivered
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-semibold inline-block text-blue-600">
                                        {{ delivery_rate|default:0 }}%
                                    </span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-1.5 mb-3 text-xs flex rounded bg-blue-200">
                                <div style="width: {{ delivery_rate|default:0|floatformat:0 }}%;" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500"></div>
                            </div>
                        </div>
                    {% endif %}

                    {% if campaign.messages_failed > 0 %}
                        {% widthratio campaign.messages_failed campaign.total_recipients 100 as failure_rate %}
                        <div class="relative pt-1 mt-3">
                            <div class="flex mb-1.5 items-center justify-between">
                                <div>
                                    <span class="text-xs font-semibold inline-block py-0.5 px-1.5 uppercase rounded-full text-red-600 bg-red-200">
                                        Failed
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-semibold inline-block text-red-600">
                                        {{ failure_rate|default:0 }}%
                                    </span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-1.5 mb-3 text-xs flex rounded bg-red-200">
                                <div style="width: {{ failure_rate|default:0|floatformat:0 }}%;" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-500"></div>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-xs text-neutral-600">No recipients</p>
                {% endif %}
            </div>

            <!-- Live Countdown Timer (for running campaigns) -->
            {% if campaign.status == 'running' %}
            <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl shadow-sm border-2 border-orange-200 p-5">
                <h3 class="font-semibold text-orange-900 mb-3 flex items-center">
                    <i class="ri-timer-line mr-2 text-orange-600"></i>
                    Campaign Progress
                </h3>
                <div class="space-y-3">
                    <!-- Configured Settings Display -->
                    <div class="bg-white rounded-lg p-3 border border-orange-200">
                        <p class="text-xs font-semibold text-neutral-700 mb-2">Configured Sending Settings:</p>
                        <div class="space-y-1 text-xs text-neutral-600">
                            <div class="flex justify-between">
                                <span>Message Delay:</span>
                                <span class="font-semibold text-orange-600">{{ campaign.random_delay_min }}-{{ campaign.random_delay_max }}s</span>
                            </div>
                            {% if campaign.use_advanced_controls %}
                            <div class="flex justify-between">
                                <span>Batch Size:</span>
                                <span class="font-semibold text-purple-600">{{ campaign.batch_size_min }}-{{ campaign.batch_size_max }} contacts</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Batch Cooldown:</span>
                                <span class="font-semibold text-blue-600">{{ campaign.batch_cooldown_min }}-{{ campaign.batch_cooldown_max }} min</span>
                            </div>
                            {% endif %}
                        </div>
                        <p class="text-xs text-neutral-500 mt-2 italic">‚úì Backend is using these settings for actual sending</p>
                    </div>
                    
                    <!-- Estimated Countdown Display -->
                    <div class="bg-white rounded-lg p-3 border border-amber-200">
                        <p class="text-xs font-semibold text-neutral-700 mb-2">Estimated Next Message:</p>
                        <div class="flex items-baseline gap-2">
                            <span id="countdownDisplay" class="text-2xl font-bold text-amber-600">--</span>
                            <span class="text-xs text-neutral-500" id="countdownUnit">seconds</span>
                        </div>
                        <p class="text-xs text-neutral-500 mt-1" id="countdownDesc">‚è±Ô∏è Random delay: {{ campaign.random_delay_min }}-{{ campaign.random_delay_max }}s per message</p>
                    </div>
                    
                    <!-- Batch Cooldown Display (only if using advanced controls) -->
                    {% if campaign.use_advanced_controls %}
                    <div class="bg-white rounded-lg p-3 border border-blue-200">
                        <p class="text-xs font-semibold text-neutral-700 mb-2">Batch Cooldown Status:</p>
                        <div class="flex items-baseline gap-2">
                            <span id="batchCooldownDisplay" class="text-2xl font-bold text-blue-600 font-mono">--:--</span>
                            <span class="text-xs text-neutral-500">min:sec</span>
                        </div>
                        <p class="text-xs text-neutral-500 mt-1" id="batchCooldownDesc">üßä Cooldown range: {{ campaign.batch_cooldown_min }}-{{ campaign.batch_cooldown_max }} min between batches</p>
                    </div>
                    {% endif %}
                    
                    <!-- Real-time Stats -->
                    <div class="bg-white rounded-lg p-3 border border-green-200">
                        <p class="text-xs font-semibold text-neutral-700 mb-2">Current Progress:</p>
                        <div class="space-y-1 text-xs text-neutral-600">
                            <div class="flex justify-between">
                                <span>Messages Sent:</span>
                                <span class="font-bold text-green-600">
                                    <span data-stat="messages-sent">{{ campaign.messages_sent }}</span> / {{ campaign.total_recipients }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Failed:</span>
                                <span class="font-bold text-red-600" data-stat="messages-failed">{{ campaign.messages_failed }}</span>
                            </div>
                        </div>
                        <div class="mt-2 w-full bg-neutral-200 rounded-full h-2">
                            {% widthratio campaign.messages_sent campaign.total_recipients 100 as progress %}
                            <div class="bg-green-500 h-2 rounded-full transition-all" data-stat="progress-bar" style="width: {{ progress|default:0 }}%"></div>
                        </div>
                    </div>
                    
                    <!-- Progress Text -->
                    <div class="text-xs text-neutral-600 text-center pt-2 border-t border-orange-200">
                        <p class="font-medium">‚è≥ Campaign is running in background</p>
                        <p class="text-neutral-500 mt-1">Stats update every 3 seconds</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Stop Campaign Confirmation Modal -->
    <div id="stopCampaignModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl border border-neutral-200 max-w-sm w-full mx-4">
            <!-- Header -->
            <div class="p-6 border-b border-neutral-200">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                        <i class="ri-alert-line text-lg text-yellow-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-neutral-900">Stop Campaign?</h3>
                </div>
            </div>
            
            <!-- Body -->
            <div class="p-6">
                <p class="text-sm text-neutral-600 leading-relaxed">
                    Are you sure you want to stop this campaign? Messages already sent will not be recalled, but no further messages will be sent.
                </p>
            </div>
            
            <!-- Footer -->
            <div class="p-6 border-t border-neutral-200 flex items-center gap-3 justify-end">
                <button type="button" onclick="closeStopModal()" class="px-4 py-2 rounded-lg border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors font-medium text-sm">
                    Cancel
                </button>
                <button type="button" onclick="confirmStopCampaign()" class="px-4 py-2 rounded-lg bg-red-100 text-red-700 border border-red-200 hover:bg-red-200 transition-colors font-medium text-sm flex items-center gap-2">
                    <i class="ri-stop-circle-line"></i>
                    Stop Campaign
                </button>
            </div>
        </div>
    </div>
    
    <!-- Stop Campaign Script -->
    <script>
    let stopCampaignId = null;
    
    function openStopModal(campaignId) {
        stopCampaignId = campaignId;
        document.getElementById('stopCampaignModal').classList.remove('hidden');
    }
    
    function closeStopModal() {
        stopCampaignId = null;
        document.getElementById('stopCampaignModal').classList.add('hidden');
    }
    
    function confirmStopCampaign() {
        if (!stopCampaignId) return;
        
        // Get CSRF token from Django's context or from page
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                          document.querySelector('meta[name="csrf-token"]')?.content || 
                          getCsrfTokenFromCookie() || '';
        
        console.log('CSRF Token:', csrfToken ? csrfToken.substring(0, 10) + '...' : 'NOT FOUND');
        
        const button = event.target.closest('button');
        button.disabled = true;
        button.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Stopping...';
        
        fetch(`/whatsappapi/campaigns/${stopCampaignId}/stop/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            // Log response status
            console.log('Stop response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Stop response data:', data);
            closeStopModal();
            // Show success message and reload page
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-[60] animate-pulse';
            successMsg.innerHTML = '<i class="ri-check-line text-lg"></i><span>Campaign stopped successfully</span>';
            document.body.appendChild(successMsg);
            // Reload to refresh UI and show paused status
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        })
        .catch(error => {
            console.error('Stop campaign error:', error);
            closeStopModal();
            button.disabled = false;
            button.innerHTML = '<i class="ri-stop-circle-line"></i> Stop Campaign';
            alert('Failed to stop campaign: ' + error.message);
        });
    }
    
    // Helper function to get CSRF token from cookie
    function getCsrfTokenFromCookie() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Close modal when clicking outside
    document.getElementById('stopCampaignModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeStopModal();
        }
    });
    </script>

    <!-- Auto-refresh stats for running campaigns -->
    <script>
    // Only refresh if campaign is running or pending
    const campaignStatusForRefresh = '{{ campaign.status }}';
    const campaignIdForRefresh = {{ campaign.id }};
    const delayMin = {{ campaign.random_delay_min|default:5 }};
    const delayMax = {{ campaign.random_delay_max|default:10 }};
    const useAdvancedControls = {{ campaign.use_advanced_controls|yesno:"true,false" }};
    const batchCooldownMin = {{ campaign.batch_cooldown_min|default:5.0 }};
    const batchCooldownMax = {{ campaign.batch_cooldown_max|default:10.0 }};
    
    // Storage key for persisting countdown across page refreshes
    const countdownStorageKey = `campaign_${campaignIdForRefresh}_countdown`;
    
    // Load or initialize countdown from sessionStorage
    function loadCountdownState() {
        const stored = sessionStorage.getItem(countdownStorageKey);
        if (stored) {
            try {
                const state = JSON.parse(stored);
                const elapsed = Math.floor((Date.now() - state.timestamp) / 1000);  // Seconds since last save
                
                // Adjust countdown based on elapsed time
                let messageCountdown = state.messageCountdown - elapsed;
                let batchCooldown = state.batchCooldown - (elapsed / 60);  // Convert to minutes
                let isBatchActive = state.isBatchCooldownActive;
                
                // If countdown went negative, generate new random
                if (messageCountdown <= 0 && !isBatchActive) {
                    messageCountdown = Math.floor(Math.random() * (delayMax - delayMin + 1)) + delayMin;
                } else if (batchCooldown <= 0 && isBatchActive) {
                    isBatchActive = false;
                    messageCountdown = Math.floor(Math.random() * (delayMax - delayMin + 1)) + delayMin;
                }
                
                return {
                    messageCountdown: messageCountdown,
                    batchCooldown: Math.max(0, batchCooldown),
                    isBatchCooldownActive: isBatchActive
                };
            } catch (e) {
                console.error('Failed to load countdown state:', e);
            }
        }
        
        // Initialize fresh
        return {
            messageCountdown: Math.floor(Math.random() * (delayMax - delayMin + 1)) + delayMin,
            batchCooldown: 0,
            isBatchCooldownActive: false
        };
    }
    
    // Save countdown state to sessionStorage
    function saveCountdownState(messageCountdown, batchCooldown, isBatchCooldownActive) {
        const state = {
            messageCountdown: messageCountdown,
            batchCooldown: batchCooldown,
            isBatchCooldownActive: isBatchCooldownActive,
            timestamp: Date.now()
        };
        sessionStorage.setItem(countdownStorageKey, JSON.stringify(state));
    }
    
    // Initialize countdowns from storage
    const initialState = loadCountdownState();
    let currentMessageCountdown = initialState.messageCountdown;
    let currentBatchCooldown = initialState.batchCooldown;
    let isBatchCooldownActive = initialState.isBatchCooldownActive;
    
    if (campaignStatusForRefresh === 'running' || campaignStatusForRefresh === 'pending') {
        // Update both countdowns
        function updateCountdowns() {
            const countdownEl = document.getElementById('countdownDisplay');
            const countdownUnitEl = document.getElementById('countdownUnit');
            const countdownDescEl = document.getElementById('countdownDesc');
            const batchCooldownEl = document.getElementById('batchCooldownDisplay');
            const batchCooldownUnitEl = document.getElementById('batchCooldownUnit');
            const batchCooldownDescEl = document.getElementById('batchCooldownDesc');
            
            if (isBatchCooldownActive && batchCooldownEl) {
                // Show batch cooldown
                if (currentBatchCooldown > 0) {
                    // Convert minutes to minutes:seconds format
                    const totalSeconds = Math.ceil(currentBatchCooldown * 60);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    const displayTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    batchCooldownEl.textContent = displayTime;
                    batchCooldownEl.classList.remove('hidden');
                    countdownEl.classList.add('text-opacity-50');
                    countdownDescEl.innerHTML = '‚ö†Ô∏è Waiting for batch cooldown...';
                    currentBatchCooldown -= 0.0167;  // Decrease by ~1 second in minutes
                } else {
                    // Cooldown finished, back to message delay
                    isBatchCooldownActive = false;
                    batchCooldownEl.textContent = '--:--';
                    batchCooldownEl.classList.add('hidden');
                    countdownEl.classList.remove('text-opacity-50');
                    currentMessageCountdown = Math.floor(Math.random() * (delayMax - delayMin + 1)) + delayMin;
                    countdownDescEl.innerHTML = '‚è±Ô∏è Random delay: {{ campaign.random_delay_min }}-{{ campaign.random_delay_max }}s per message';
                }
            } else {
                // Show message countdown
                if (countdownEl) {
                    if (currentMessageCountdown > 0) {
                        countdownEl.textContent = currentMessageCountdown;
                        countdownUnitEl.textContent = 'seconds';
                        currentMessageCountdown--;
                    } else {
                        // Message sent, generate new countdown or start batch cooldown
                        if (useAdvancedControls && Math.random() < 0.2) {  // 20% chance to simulate batch completion
                            // Start batch cooldown
                            isBatchCooldownActive = true;
                            currentBatchCooldown = Math.random() * (batchCooldownMax - batchCooldownMin) + batchCooldownMin;
                            countdownEl.textContent = '--';
                            countdownUnitEl.textContent = 'seconds';
                            countdownDescEl.innerHTML = '‚ö†Ô∏è Batch completed, waiting for cooldown';
                        } else {
                            // Next message
                            currentMessageCountdown = Math.floor(Math.random() * (delayMax - delayMin + 1)) + delayMin;
                            countdownEl.textContent = currentMessageCountdown;
                            countdownUnitEl.textContent = 'seconds';
                        }
                    }
                }
            }
            
            // Save state to sessionStorage so it persists across page refreshes
            saveCountdownState(currentMessageCountdown, currentBatchCooldown, isBatchCooldownActive);
        }
        
        // Update countdowns every second
        const countdownInterval = setInterval(updateCountdowns, 1000);
        
        // Use AJAX to update real stats without full page reload
        let hasReloaded = false;  // Prevent infinite reloads
        function updateCampaignStats() {
            fetch(`/whatsappapi/campaigns/${campaignIdForRefresh}/stats/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('üìä Stats Update:', data);  // Log the data
                
                // Update messages sent
                const sentElements = document.querySelectorAll('[data-stat="messages-sent"]');
                sentElements.forEach(el => {
                    el.textContent = data.messages_sent || 0;
                });
                
                // Update messages failed
                const failedElements = document.querySelectorAll('[data-stat="messages-failed"]');
                failedElements.forEach(el => {
                    el.textContent = data.messages_failed || 0;
                });
                
                // Update progress bar
                const progressBar = document.querySelector('[data-stat="progress-bar"]');
                if (progressBar && data.total_recipients > 0) {
                    const progress = Math.round((data.messages_sent / data.total_recipients) * 100);
                    progressBar.style.width = progress + '%';
                }
                
                // If status changed to completed/failed/paused, reload page ONLY ONCE
                if (!hasReloaded && data.status !== campaignStatusForRefresh && 
                    (data.status === 'completed' || data.status === 'failed' || data.status === 'paused')) {
                    console.log('Campaign status changed to', data.status, ', reloading...');
                    hasReloaded = true;
                    clearInterval(countdownInterval);
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('‚ùå Failed to fetch campaign stats:', error);
            });
        }
        
        // Update stats every 3 seconds (faster than page reload)
        const statsInterval = setInterval(updateCampaignStats, 3000);
        
        // Initial update
        updateCampaignStats();
        
        // Clear interval when page is about to unload
        window.addEventListener('beforeunload', () => {
            clearInterval(statsInterval);
            clearInterval(countdownInterval);
        });
    }
    </script>
</div>
</div>
</div>
{% endblock %}