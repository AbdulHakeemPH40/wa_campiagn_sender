{% extends 'whatsappapi/base.html' %}
{% load static %}

{% block title %}Campaign Detail{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
<div class="max-w-7xl mx-auto">
<div class="space-y-5">
    <!-- Back Button -->
    <div>
        <a href="{% url 'whatsappapi:campaigns' %}" class="text-sm text-neutral-600 hover:text-neutral-900 inline-flex items-center">
            <i class="ri-arrow-left-line mr-1"></i>
            Back to Campaigns
        </a>
    </div>

    <!-- Campaign Header -->
    <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4">
            <div class="flex-1 min-w-0">
                <h2 class="text-lg sm:text-xl font-bold text-neutral-900 break-words">{{ campaign.name }}</h2>
                <div class="flex flex-wrap items-center gap-2 mt-2 text-xs text-neutral-600">
                    <span><i class="ri-calendar-line mr-1"></i>{{ campaign.created_at|date:"M d, Y H:i" }}</span>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <span class="px-2.5 py-1 rounded-full text-xs font-semibold
                    {% if campaign.status == 'completed' %}bg-green-100 text-green-800
                    {% elif campaign.status == 'running' %}bg-blue-100 text-blue-800
                    {% elif campaign.status == 'failed' %}bg-red-100 text-red-800
                    {% elif campaign.status == 'paused' %}bg-yellow-100 text-yellow-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ campaign.status|title }}
                </span>
                {% if campaign.status == 'running' or campaign.status == 'pending' %}
                <button type="button" onclick="openStopModal({{ campaign.id }})" class="px-3 py-2 bg-red-100 text-red-700 border border-red-200 rounded-lg hover:bg-red-200 transition-colors inline-flex items-center text-xs font-semibold">
                    <i class="ri-stop-circle-line mr-1"></i>Stop
                </button>
                {% endif %}
                <a href="{% url 'whatsappapi:export_campaign_messages_excel' campaign.id %}" 
                   class="px-3 py-2 bg-green-100 text-green-700 border border-green-200 rounded-lg hover:bg-green-200 transition-colors inline-flex items-center text-xs font-semibold">
                    <i class="ri-file-excel-2-line mr-1"></i>Export
                </a>
            </div>
        </div>
    </div>

    <!-- Session/Sent From Banner -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 p-4 sm:p-5">
        <div class="flex items-center gap-3">
            <div class="h-12 w-12 bg-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                <i class="ri-smartphone-line text-white text-2xl"></i>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-xs sm:text-sm font-medium text-neutral-600 mb-1">Sent From WhatsApp Number:</p>
                <div class="flex flex-wrap items-center gap-2">
                    <p class="text-base sm:text-lg font-bold text-blue-700">{{ campaign.session.connected_phone_number|default:campaign.session.phone_number }}</p>
                    {% if campaign.session.status == 'connected' %}
                    <span class="px-2.5 py-1 bg-green-100 text-green-700 border border-green-200 rounded-lg text-xs font-semibold inline-flex items-center">
                        <i class="ri-checkbox-circle-fill mr-1"></i>
                        Active
                    </span>
                    {% elif campaign.session.status == 'disconnected' %}
                    <span class="px-2.5 py-1 bg-red-100 text-red-700 border border-red-200 rounded-lg text-xs font-semibold inline-flex items-center">
                        <i class="ri-close-circle-fill mr-1"></i>
                        Disconnected
                    </span>
                    {% endif %}
                </div>
                <p class="text-xs text-neutral-500 mt-1">{{ campaign.session.session_name }}</p>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4">
        <!-- Total Recipients -->
        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">Total</p>
                    <p class="text-2xl font-bold text-neutral-900 mt-1" data-stat="total-recipients">{{ campaign.total_recipients }}</p>
                </div>
                <div class="h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="ri-group-line text-xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <!-- Messages Sent -->
        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">Sent</p>
                    <p class="text-2xl font-bold text-neutral-900 mt-1" data-stat="messages-sent">{{ campaign.messages_sent }}</p>
                </div>
                <div class="h-10 w-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="ri-send-plane-2-line text-xl text-green-600"></i>
                </div>
            </div>
        </div>

        <!-- Messages Delivered -->
        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">‚úÖ Delivered</p>
                    <p class="text-2xl font-bold text-green-600 mt-1" data-stat="messages-delivered">{{ campaign.messages_delivered|default:0 }}</p>
                </div>
                <div class="h-10 w-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="ri-checkbox-circle-line text-xl text-green-600"></i>
                </div>
            </div>
        </div>

        <!-- Messages Read -->
        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">üìñ Read</p>
                    <p class="text-2xl font-bold text-blue-600 mt-1" data-stat="messages-read">{{ campaign.messages_read|default:0 }}</p>
                </div>
                <div class="h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="ri-eye-line text-xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <!-- Messages Failed -->
        <div class="bg-white rounded-lg shadow-sm border border-neutral-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-neutral-600">‚ùå Failed</p>
                    <p class="text-2xl font-bold text-red-600 mt-1" data-stat="messages-failed">{{ campaign.messages_failed }}</p>
                </div>
                <div class="h-10 w-10 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="ri-close-circle-line text-xl text-red-600"></i>
                </div>
            </div>
        </div>

        <!-- Success Rate -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg shadow-sm border-2 border-green-200 p-3 sm:p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-green-700">Success Rate</p>
                    <p class="text-2xl font-bold text-green-600 mt-1">
                        <span data-stat="success-rate">{% widthratio campaign.messages_delivered campaign.total_recipients 100 %}</span>%
                    </p>
                </div>
                <div class="h-10 w-10 bg-green-200 rounded-lg flex items-center justify-center">
                    <i class="ri-trophy-line text-xl text-green-700"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Details -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
        <!-- Message Template -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-5">
                <h3 class="text-lg font-semibold text-neutral-900 mb-3">Message Template</h3>
                <div class="bg-neutral-50 rounded-lg p-3 border border-neutral-200">
                    <pre class="text-sm text-neutral-700 whitespace-pre-wrap font-sans">{{ campaign.message_template }}</pre>
                </div>
            </div>

            <!-- Messages List -->
            {% if campaign_messages %}
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-5 mt-5">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-neutral-900">Messages</h3>
                    <span class="px-2 py-1 bg-neutral-100 text-neutral-700 rounded-full text-xs font-semibold">
                        {{ campaign_messages.paginator.count }}
                    </span>
                </div>
                <div class="space-y-2 max-h-80 overflow-y-auto">
                    {% for message in campaign_messages %}
                    <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg hover:bg-neutral-100 transition-colors">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <div class="h-8 w-8 rounded-full flex items-center justify-center flex-shrink-0
                                {% if message.status == 'sent' or message.status == 'delivered' or message.status == 'read' %}bg-green-100
                                {% elif message.status == 'failed' %}bg-red-100
                                {% else %}bg-yellow-100{% endif %}">
                                <i class="{% if message.status == 'sent' or message.status == 'delivered' or message.status == 'read' %}ri-checkbox-circle-fill text-green-600
                                    {% elif message.status == 'failed' %}ri-close-circle-fill text-red-600
                                    {% else %}ri-time-fill text-yellow-600{% endif %} text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-neutral-900 truncate">{{ message.recipient }}</p>
                                <p class="text-xs text-neutral-600 truncate">{{ message.sent_at|date:"M d, Y H:i:s"|default:"Not sent" }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium
                                {% if message.status == 'sent' %}bg-blue-100 text-blue-800
                                {% elif message.status == 'delivered' %}bg-green-100 text-green-800
                                {% elif message.status == 'read' %}bg-purple-100 text-purple-800
                                {% elif message.status == 'failed' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ message.status|title }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if campaign_messages %}
                <div class="flex items-center justify-between mt-4 pt-4 border-t border-neutral-200">
                    <div class="text-xs text-neutral-600">
                        Showing <span class="font-semibold">{{ campaign_messages.start_index }}</span> to <span class="font-semibold">{{ campaign_messages.end_index }}</span> of <span class="font-semibold">{{ campaign_messages.paginator.count }}</span> messages
                    </div>
                    
                    <div class="flex items-center space-x-1">
                        {% if campaign_messages.has_previous %}
                            <a href="?page=1" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">
                                <i class="ri-arrow-left-double-line"></i>
                            </a>
                            <a href="?page={{ campaign_messages.previous_page_number }}" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">
                                <i class="ri-arrow-left-line"></i>
                            </a>
                        {% endif %}
                        
                        {% for num in campaign_messages.paginator.page_range %}
                            {% if campaign_messages.number == num %}
                                <span class="px-2 py-1 rounded bg-blue-600 text-white font-semibold text-xs">{{ num }}</span>
                            {% elif num > campaign_messages.number|add:'-2' and num < campaign_messages.number|add:'2' %}
                                <a href="?page={{ num }}" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if campaign_messages.has_next %}
                            <a href="?page={{ campaign_messages.next_page_number }}" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">
                                <i class="ri-arrow-right-line"></i>
                            </a>
                            <a href="?page={{ campaign_messages.paginator.num_pages }}" class="px-2 py-1 rounded border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors text-xs">
                                <i class="ri-arrow-right-double-line"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar Info -->
        <div class="lg:col-span-1 space-y-5">
            <!-- Campaign Info -->
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 p-5">
                <h3 class="font-semibold text-neutral-900 mb-3">Campaign Info</h3>
                <div class="space-y-2.5 text-sm">
                    <div>
                        <p class="text-neutral-600 text-xs">Created</p>
                        <p class="font-medium text-neutral-900">{{ campaign.created_at|date:"M d, Y H:i" }}</p>
                    </div>
                    {% if campaign.started_at %}
                    <div>
                        <p class="text-neutral-600 text-xs">Started</p>
                        <p class="font-medium text-neutral-900">{{ campaign.started_at|date:"M d, Y H:i" }}</p>
                    </div>
                    {% endif %}
                    {% if campaign.completed_at %}
                    <div>
                        <p class="text-neutral-600 text-xs">Completed</p>
                        <p class="font-medium text-neutral-900">{{ campaign.completed_at|date:"M d, Y H:i" }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-neutral-600 text-xs">Message Type</p>
                        <p class="font-medium text-neutral-900">{{ campaign.message_type|title }}</p>
                    </div>
                </div>
            </div>

            <!-- Batch Progress & Cooldown Status (Only for Advanced Controls) -->
            {% if campaign.use_advanced_controls and campaign.status == 'running' %}
            <div id="cooldownStatusCard" class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl shadow-sm border-2 border-orange-200 p-5">
                <h3 class="font-semibold text-neutral-900 mb-3 flex items-center">
                    <i class="ri-timer-line text-orange-600 mr-2"></i>
                    Batch Progress
                </h3>
                
                <!-- Batch Counter -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-semibold text-neutral-600">Current Batch</span>
                        <span class="text-sm font-bold text-orange-600" id="batchCounter">
                            <span data-stat="current-batch">{{ campaign.current_batch|default:0 }}</span> / <span data-stat="total-batches">{{ campaign.total_batches|default:0 }}</span>
                        </span>
                    </div>
                    <div class="w-full bg-orange-200 rounded-full h-2">
                        <div id="batchProgressBar" class="bg-orange-500 h-2 rounded-full transition-all duration-300" 
                             style="width: {% if campaign.total_batches > 0 %}{{ campaign.current_batch|default:0|floatformat:0 }}{% else %}0{% endif %}%"></div>
                    </div>
                </div>
                
                <!-- Cooldown Status -->
                <div id="cooldownStatusDisplay" class="{% if not campaign.cooldown_status %}hidden{% endif %}">
                    <div class="bg-white rounded-lg p-3 border border-orange-300">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="animate-spin rounded-full h-5 w-5 border-2 border-orange-500 border-t-transparent"></div>
                            </div>
                            <div class="ml-3 flex-1">
                                <p class="text-xs font-semibold text-orange-800 mb-1">‚è≥ Cooldown Active</p>
                                <p class="text-xs text-orange-700" id="cooldownStatusText" data-stat="cooldown-status">
                                    {{ campaign.cooldown_status|default:"Waiting between batches..." }}
                                </p>
                                <div class="mt-2">
                                    <div class="flex items-center justify-between text-xs">
                                        <span class="text-orange-600">Time Remaining:</span>
                                        <span class="font-bold text-orange-700" id="cooldownTimeRemaining" data-stat="cooldown-remaining">
                                            {{ campaign.cooldown_remaining|default:0 }}s
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- No Cooldown Message -->
                <div id="noCooldownMessage" class="{% if campaign.cooldown_status %}hidden{% endif %} text-center py-2">
                    <p class="text-xs text-neutral-500">
                        <i class="ri-checkbox-circle-line text-green-500 mr-1"></i>
                        Sending messages...
                    </p>
                </div>
            </div>
            {% endif %}

            <!-- Message Statistics -->
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 border-b border-neutral-200">
                    <h3 class="font-semibold text-neutral-900 text-sm flex items-center gap-2">
                        <i class="ri-bar-chart-box-line text-blue-600"></i>
                        Message Statistics
                    </h3>
                </div>
                
                {% if campaign.total_recipients > 0 %}
                <div class="p-4 space-y-3">
                    <!-- Sent -->
                    <div>
                        <div class="flex items-center justify-between mb-1.5">
                            <div class="flex items-center gap-2">
                                <i class="ri-send-plane-fill text-green-600 text-sm"></i>
                                <span class="text-xs font-semibold text-neutral-700">Sent</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-neutral-800" data-stat="messages-sent">{{ campaign.messages_sent|default:0 }}</span>
                                <span class="text-xs text-neutral-500">/</span>
                                <span class="text-xs text-neutral-500">{{ campaign.total_recipients }}</span>
                                <span class="text-xs font-semibold text-green-600 ml-1" data-stat="sent-percent">
                                    {% widthratio campaign.messages_sent campaign.total_recipients 100 as sent_rate %}{{ sent_rate|default:0 }}%
                                </span>
                            </div>
                        </div>
                        <div class="w-full bg-green-100 rounded-full h-1.5">
                            {% widthratio campaign.messages_sent campaign.total_recipients 100 as sent_rate %}
                            <div class="bg-green-500 h-1.5 rounded-full transition-all" data-stat="sent-bar" style="width: {{ sent_rate|default:0 }}%"></div>
                        </div>
                    </div>

                    <!-- Delivered -->
                    <div>
                        <div class="flex items-center justify-between mb-1.5">
                            <div class="flex items-center gap-2">
                                <i class="ri-checkbox-circle-fill text-blue-600 text-sm"></i>
                                <span class="text-xs font-semibold text-neutral-700">Delivered</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-neutral-800" data-stat="messages-delivered">{{ campaign.messages_delivered|default:0 }}</span>
                                <span class="text-xs text-neutral-500">/</span>
                                <span class="text-xs text-neutral-500">{{ campaign.total_recipients }}</span>
                                <span class="text-xs font-semibold text-blue-600 ml-1" data-stat="delivered-percent">
                                    {% widthratio campaign.messages_delivered campaign.total_recipients 100 as delivered_rate %}{{ delivered_rate|default:0 }}%
                                </span>
                            </div>
                        </div>
                        <div class="w-full bg-blue-100 rounded-full h-1.5">
                            {% widthratio campaign.messages_delivered campaign.total_recipients 100 as delivered_rate %}
                            <div class="bg-blue-500 h-1.5 rounded-full transition-all" data-stat="delivered-bar" style="width: {{ delivered_rate|default:0 }}%"></div>
                        </div>
                    </div>

                    <!-- Read -->
                    <div>
                        <div class="flex items-center justify-between mb-1.5">
                            <div class="flex items-center gap-2">
                                <i class="ri-eye-fill text-purple-600 text-sm"></i>
                                <span class="text-xs font-semibold text-neutral-700">Read</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-neutral-800" data-stat="messages-read">{{ campaign.messages_read|default:0 }}</span>
                                <span class="text-xs text-neutral-500">/</span>
                                <span class="text-xs text-neutral-500">{{ campaign.total_recipients }}</span>
                                <span class="text-xs font-semibold text-purple-600 ml-1" data-stat="read-percent">
                                    {% widthratio campaign.messages_read campaign.total_recipients 100 as read_rate %}{{ read_rate|default:0 }}%
                                </span>
                            </div>
                        </div>
                        <div class="w-full bg-purple-100 rounded-full h-1.5">
                            {% widthratio campaign.messages_read campaign.total_recipients 100 as read_rate %}
                            <div class="bg-purple-500 h-1.5 rounded-full transition-all" data-stat="read-bar" style="width: {{ read_rate|default:0 }}%"></div>
                        </div>
                    </div>

                    <!-- Failed -->
                    <div>
                        <div class="flex items-center justify-between mb-1.5">
                            <div class="flex items-center gap-2">
                                <i class="ri-close-circle-fill text-red-600 text-sm"></i>
                                <span class="text-xs font-semibold text-neutral-700">Failed</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-neutral-800" data-stat="messages-failed">{{ campaign.messages_failed|default:0 }}</span>
                                <span class="text-xs text-neutral-500">/</span>
                                <span class="text-xs text-neutral-500">{{ campaign.total_recipients }}</span>
                                <span class="text-xs font-semibold text-red-600 ml-1" data-stat="failed-percent">
                                    {% widthratio campaign.messages_failed campaign.total_recipients 100 as failed_rate %}{{ failed_rate|default:0 }}%
                                </span>
                            </div>
                        </div>
                        <div class="w-full bg-red-100 rounded-full h-1.5">
                            {% widthratio campaign.messages_failed campaign.total_recipients 100 as failed_rate %}
                            <div class="bg-red-500 h-1.5 rounded-full transition-all" data-stat="failed-bar" style="width: {{ failed_rate|default:0 }}%"></div>
                        </div>
                    </div>

                    <!-- Info Note -->
                    <div class="pt-2 border-t border-neutral-200">
                        <p class="text-xs text-neutral-500 flex items-center gap-1">
                            <i class="ri-information-line"></i>
                            Delivered & Read stats update via webhook
                        </p>
                    </div>
                </div>
                {% else %}
                    <div class="p-4">
                        <p class="text-xs text-neutral-600 text-center">No recipients</p>
                    </div>
                {% endif %}
            </div>

            <!-- Campaign Progress (for running campaigns) -->
            {% if campaign.status == 'running' %}
            <div class="bg-white rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-4 py-3 border-b border-neutral-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="h-8 w-8 bg-green-500 rounded-lg flex items-center justify-center">
                                <i class="ri-play-circle-fill text-white text-lg"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-neutral-800 text-sm">Campaign Running</h3>
                                <p class="text-xs text-neutral-600">Live progress updates</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1 bg-green-100 rounded-full">
                            <div class="animate-pulse h-2 w-2 bg-green-500 rounded-full"></div>
                            <span class="text-xs font-semibold text-green-700">Active</span>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-4 space-y-3">
                    <!-- Progress Stats -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200">
                            <p class="text-xs text-neutral-600 mb-1">Sent</p>
                            <p class="text-lg font-bold text-green-600">
                                <span data-stat="messages-sent">{{ campaign.messages_sent }}</span>
                                <span class="text-sm text-neutral-500">/ {{ campaign.total_recipients }}</span>
                            </p>
                            <div class="mt-2 w-full bg-green-200 rounded-full h-1.5">
                                {% widthratio campaign.messages_sent campaign.total_recipients 100 as progress %}
                                <div class="bg-green-500 h-1.5 rounded-full transition-all" data-stat="progress-bar" style="width: {{ progress|default:0 }}%"></div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-rose-50 rounded-lg p-3 border border-red-200">
                            <p class="text-xs text-neutral-600 mb-1">Failed</p>
                            <p class="text-lg font-bold text-red-600" data-stat="messages-failed">{{ campaign.messages_failed }}</p>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="bg-neutral-50 rounded-lg p-3 border border-neutral-200">
                        <p class="text-xs font-semibold text-neutral-700 mb-2 flex items-center gap-1">
                            <i class="ri-settings-3-line text-neutral-500"></i>
                            Sending Configuration
                        </p>
                        <div class="grid grid-cols-{% if campaign.use_advanced_controls %}3{% else %}1{% endif %} gap-2 text-xs">
                            <div class="flex items-center gap-2">
                                <i class="ri-time-line text-orange-500"></i>
                                <span class="text-neutral-600">Delay:</span>
                                <span class="font-semibold text-neutral-800">{{ campaign.random_delay_min }}-{{ campaign.random_delay_max }}s</span>
                            </div>
                            {% if campaign.use_advanced_controls %}
                            <div class="flex items-center gap-2">
                                <i class="ri-stack-line text-purple-500"></i>
                                <span class="text-neutral-600">Batch:</span>
                                <span class="font-semibold text-neutral-800">{{ campaign.batch_size_min }}-{{ campaign.batch_size_max }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="ri-timer-line text-blue-500"></i>
                                <span class="text-neutral-600">Cooldown:</span>
                                <span class="font-semibold text-neutral-800">{{ campaign.batch_cooldown_min }}-{{ campaign.batch_cooldown_max }}m</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Batch Cooldown Status (only if using advanced controls) -->
                    {% if campaign.use_advanced_controls %}
                    <div id="batchCooldownCard" class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                        <div id="cooldownActive" class="hidden">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold text-blue-800 mb-1">Batch Cooldown</p>
                                    <p class="text-xs text-blue-600" id="realCooldownStatus">Waiting between batches...</p>
                                </div>
                                <div class="text-right">
                                    <span id="realCooldownDisplay" class="text-2xl font-bold text-blue-600 font-mono">--:--</span>
                                    <p class="text-xs text-neutral-500">remaining</p>
                                </div>
                            </div>
                        </div>
                        <div id="cooldownInactive">
                            <div class="flex items-center gap-2">
                                <i class="ri-checkbox-circle-fill text-green-500"></i>
                                <div>
                                    <p class="text-xs font-semibold text-neutral-700">Sending Messages</p>
                                    <p class="text-xs text-neutral-500">No cooldown active</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Info Footer -->
                    <div class="flex items-center justify-center gap-2 pt-2 border-t border-neutral-200">
                        <i class="ri-information-line text-neutral-400 text-sm"></i>
                        <p class="text-xs text-neutral-500">Updates every 3 seconds ‚Ä¢ Backend controlled</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Stop Campaign Confirmation Modal -->
    <div id="stopCampaignModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl border border-neutral-200 max-w-sm w-full mx-4">
            <!-- Header -->
            <div class="p-6 border-b border-neutral-200">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                        <i class="ri-alert-line text-lg text-yellow-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-neutral-900">Stop Campaign?</h3>
                </div>
            </div>
            
            <!-- Body -->
            <div class="p-6">
                <p class="text-sm text-neutral-600 leading-relaxed">
                    Are you sure you want to stop this campaign? Messages already sent will not be recalled, but no further messages will be sent.
                </p>
            </div>
            
            <!-- Footer -->
            <div class="p-6 border-t border-neutral-200 flex items-center gap-3 justify-end">
                <button type="button" onclick="closeStopModal()" class="px-4 py-2 rounded-lg border border-neutral-300 text-neutral-700 hover:bg-neutral-50 transition-colors font-medium text-sm">
                    Cancel
                </button>
                <button type="button" onclick="confirmStopCampaign()" class="px-4 py-2 rounded-lg bg-red-100 text-red-700 border border-red-200 hover:bg-red-200 transition-colors font-medium text-sm flex items-center gap-2">
                    <i class="ri-stop-circle-line"></i>
                    Stop Campaign
                </button>
            </div>
        </div>
    </div>
</div>
</div>
</div>
{% endblock %}

{% block scripts %}
    <!-- Stop Campaign Script -->
    <script>
    let stopCampaignId = null;
    
    function openStopModal(campaignId) {
        stopCampaignId = campaignId;
        document.getElementById('stopCampaignModal').classList.remove('hidden');
    }
    
    function closeStopModal() {
        stopCampaignId = null;
        document.getElementById('stopCampaignModal').classList.add('hidden');
    }
    
    function confirmStopCampaign() {
        if (!stopCampaignId) return;
        
        // Get CSRF token from Django's context or from page
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                          document.querySelector('meta[name="csrf-token"]')?.content || 
                          getCsrfTokenFromCookie() || '';
        
        console.log('CSRF Token:', csrfToken ? csrfToken.substring(0, 10) + '...' : 'NOT FOUND');
        
        const button = event.target.closest('button');
        button.disabled = true;
        button.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Stopping...';
        
        fetch(`/whatsappapi/campaigns/${stopCampaignId}/stop/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            // Log response status
            console.log('Stop response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Stop response data:', data);
            closeStopModal();
            // Show success message and reload page
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-[60] animate-pulse';
            successMsg.innerHTML = '<i class="ri-check-line text-lg"></i><span>Campaign stopped successfully</span>';
            document.body.appendChild(successMsg);
            // Reload to refresh UI and show paused status
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        })
        .catch(error => {
            console.error('Stop campaign error:', error);
            closeStopModal();
            button.disabled = false;
            button.innerHTML = '<i class="ri-stop-circle-line"></i> Stop Campaign';
            alert('Failed to stop campaign: ' + error.message);
        });
    }
    
    // Helper function to get CSRF token from cookie
    function getCsrfTokenFromCookie() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Close modal when clicking outside
    document.getElementById('stopCampaignModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeStopModal();
        }
    });
    </script>

    <!-- Auto-refresh stats for running campaigns -->
    <script>
    // Only refresh if campaign is running or pending
    const campaignStatusForRefresh = '{{ campaign.status }}';
    const campaignIdForRefresh = {{ campaign.id }};
    const delayMin = {{ campaign.random_delay_min|default:5 }};
    const delayMax = {{ campaign.random_delay_max|default:10 }};
    const useAdvancedControls = {{ campaign.use_advanced_controls|yesno:"true,false" }};
    const batchCooldownMin = {{ campaign.batch_cooldown_min|default:5.0 }};
    const batchCooldownMax = {{ campaign.batch_cooldown_max|default:10.0 }};
    
    if (campaignStatusForRefresh === 'running' || campaignStatusForRefresh === 'pending') {
        // Use AJAX to update REAL backend stats without page reload
        let hasReloaded = false;  // Prevent infinite reloads
        function updateCampaignStats() {
            fetch(`/whatsappapi/campaigns/${campaignIdForRefresh}/stats/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('üìä Stats Update:', data);  // Log the data
                
                // Update messages sent (no flickering - only if changed)
                const sentElements = document.querySelectorAll('[data-stat="messages-sent"]');
                sentElements.forEach(el => {
                    const newValue = data.messages_sent || 0;
                    if (el.textContent != newValue) {
                        el.textContent = newValue;
                    }
                });
                
                // Update messages delivered
                const deliveredElements = document.querySelectorAll('[data-stat="messages-delivered"]');
                deliveredElements.forEach(el => {
                    const newValue = data.messages_delivered || 0;
                    if (el.textContent != newValue) {
                        el.textContent = newValue;
                    }
                });
                
                // Update messages read
                const readElements = document.querySelectorAll('[data-stat="messages-read"]');
                readElements.forEach(el => {
                    const newValue = data.messages_read || 0;
                    if (el.textContent != newValue) {
                        el.textContent = newValue;
                    }
                });
                
                // Update messages failed
                const failedElements = document.querySelectorAll('[data-stat="messages-failed"]');
                failedElements.forEach(el => {
                    const newValue = data.messages_failed || 0;
                    if (el.textContent != newValue) {
                        el.textContent = newValue;
                    }
                });
                
                // Update success rate
                const successRateElements = document.querySelectorAll('[data-stat="success-rate"]');
                successRateElements.forEach(el => {
                    const newValue = data.success_rate || 0;
                    if (el.textContent != newValue) {
                        el.textContent = newValue;
                    }
                });
                
                // Update progress bar smoothly
                const progressBar = document.querySelector('[data-stat="progress-bar"]');
                if (progressBar && data.total_recipients > 0) {
                    const progress = Math.round((data.messages_sent / data.total_recipients) * 100);
                    progressBar.style.width = progress + '%';
                }
                
                // Update Message Statistics percentages and bars
                if (data.total_recipients > 0) {
                    // Sent percentage
                    const sentPercent = Math.round((data.messages_sent / data.total_recipients) * 100);
                    const sentPercentEl = document.querySelector('[data-stat="sent-percent"]');
                    if (sentPercentEl) sentPercentEl.textContent = sentPercent + '%';
                    const sentBar = document.querySelector('[data-stat="sent-bar"]');
                    if (sentBar) sentBar.style.width = sentPercent + '%';
                    
                    // Delivered percentage
                    const deliveredPercent = Math.round((data.messages_delivered / data.total_recipients) * 100);
                    const deliveredPercentEl = document.querySelector('[data-stat="delivered-percent"]');
                    if (deliveredPercentEl) deliveredPercentEl.textContent = deliveredPercent + '%';
                    const deliveredBar = document.querySelector('[data-stat="delivered-bar"]');
                    if (deliveredBar) deliveredBar.style.width = deliveredPercent + '%';
                    
                    // Read percentage
                    const readPercent = Math.round((data.messages_read / data.total_recipients) * 100);
                    const readPercentEl = document.querySelector('[data-stat="read-percent"]');
                    if (readPercentEl) readPercentEl.textContent = readPercent + '%';
                    const readBar = document.querySelector('[data-stat="read-bar"]');
                    if (readBar) readBar.style.width = readPercent + '%';
                    
                    // Failed percentage
                    const failedPercent = Math.round((data.messages_failed / data.total_recipients) * 100);
                    const failedPercentEl = document.querySelector('[data-stat="failed-percent"]');
                    if (failedPercentEl) failedPercentEl.textContent = failedPercent + '%';
                    const failedBar = document.querySelector('[data-stat="failed-bar"]');
                    if (failedBar) failedBar.style.width = failedPercent + '%';
                }
                
                // Update batch progress & cooldown (if advanced controls enabled)
                if (data.use_advanced_controls) {
                    const currentBatchEl = document.querySelector('[data-stat="current-batch"]');
                    const totalBatchesEl = document.querySelector('[data-stat="total-batches"]');
                    const batchProgressBar = document.getElementById('batchProgressBar');
                    
                    if (currentBatchEl && data.current_batch !== undefined) {
                        currentBatchEl.textContent = data.current_batch || 0;
                    }
                    if (totalBatchesEl && data.total_batches !== undefined) {
                        totalBatchesEl.textContent = data.total_batches || 0;
                    }
                    if (batchProgressBar && data.total_batches > 0) {
                        const batchProgress = Math.round((data.current_batch / data.total_batches) * 100);
                        batchProgressBar.style.width = batchProgress + '%';
                    }
                    
                    // Update cooldown status
                    const cooldownStatusDisplay = document.getElementById('cooldownStatusDisplay');
                    const noCooldownMessage = document.getElementById('noCooldownMessage');
                    const cooldownStatusText = document.getElementById('cooldownStatusText');
                    const cooldownTimeRemaining = document.getElementById('cooldownTimeRemaining');
                    
                    if (data.cooldown_remaining > 0 && data.cooldown_status) {
                        // Show cooldown
                        if (cooldownStatusDisplay) cooldownStatusDisplay.classList.remove('hidden');
                        if (noCooldownMessage) noCooldownMessage.classList.add('hidden');
                        
                        if (cooldownStatusText) {
                            cooldownStatusText.textContent = data.cooldown_status;
                        }
                        if (cooldownTimeRemaining) {
                            const minutes = Math.floor(data.cooldown_remaining / 60);
                            const seconds = data.cooldown_remaining % 60;
                            cooldownTimeRemaining.textContent = `${minutes}m ${seconds}s`;
                        }
                    } else {
                        // Hide cooldown
                        if (cooldownStatusDisplay) cooldownStatusDisplay.classList.add('hidden');
                        if (noCooldownMessage) noCooldownMessage.classList.remove('hidden');
                    }
                }
                
                // If status changed to completed/failed/paused, reload page ONLY ONCE
                if (!hasReloaded && data.status !== campaignStatusForRefresh && 
                    (data.status === 'completed' || data.status === 'failed' || data.status === 'paused')) {
                    console.log('Campaign status changed to', data.status, ', reloading...');
                    hasReloaded = true;
                    clearInterval(statsInterval);
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('‚ùå Failed to fetch campaign stats:', error);
            });
        }
        
        // Update stats every 3 seconds
        const statsInterval = setInterval(updateCampaignStats, 3000);
        
        // Initial update
        updateCampaignStats();
        
        // Clear interval when page is about to unload
        window.addEventListener('beforeunload', () => {
            clearInterval(statsInterval);
        });
    }
    </script>
{% endblock %}